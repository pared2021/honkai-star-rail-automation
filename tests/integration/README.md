# 真实游戏环境集成测试

本目录包含用于验证GameDetector模块在实际游戏运行时检测准确性的集成测试。

## 测试概述

与传统的单元测试不同，这些集成测试不使用Jest mock，而是直接与真实的游戏进程交互，以验证GameDetector模块在实际环境中的表现。

## 测试内容

### 1. 游戏进程检测测试
- 验证是否能正确识别真实的游戏进程
- 检查进程信息获取的准确性（PID、进程名、CPU、内存使用等）
- 测试多种游戏进程名的识别能力

### 2. 窗口信息获取准确性测试
- 验证游戏窗口信息的获取是否准确
- 检查窗口标题、位置、大小等信息
- 验证窗口状态（可见性、最小化状态）的检测
- 测试窗口信息的一致性

### 3. 游戏状态实时监控测试
- 验证实时监控功能的有效性
- 测试状态变化事件的触发
- 检查监控的稳定性和准确性
- 验证事件系统的正常工作

### 4. 配置更新功能测试
- 验证配置更新是否在真实环境中生效
- 测试检测间隔、日志级别等配置的动态更新
- 确保配置变更不影响检测功能

### 5. 游戏启动等待功能测试
- 验证游戏启动等待功能的可靠性
- 测试超时机制的正确性
- 检查等待过程中的状态监控

## 使用方法

### 前置条件

1. **启动游戏**: 确保目标游戏（崩坏：星穹铁道）已启动并可见
2. **游戏窗口**: 游戏窗口应处于可见状态，不要最小化
3. **权限**: 确保程序有足够权限访问进程和窗口信息

### 运行测试

#### 方法1: 使用npm脚本（推荐）
```bash
npm run test:real-game
```

#### 方法2: 直接运行TypeScript文件
```bash
npx tsx scripts/run-real-game-test.ts
```

#### 方法3: 直接运行测试文件
```bash
npx tsx tests/integration/real-game-test.ts
```

### 测试流程

1. 启动测试脚本
2. 脚本会提示确认游戏已启动
3. 按Enter键开始测试
4. 测试将自动运行所有测试项目
5. 查看测试结果和详细日志
6. 测试日志会自动保存到 `logs/` 目录

## 测试结果解读

### 成功标识
- ✓ 表示测试通过
- ⚠ 表示警告（通常不影响功能）
- ✗ 表示测试失败

### 常见问题

#### 游戏进程检测失败
- **原因**: 游戏未启动或进程名不匹配
- **解决**: 确保游戏正在运行，检查进程名配置

#### 窗口信息获取失败
- **原因**: 游戏窗口被最小化或隐藏
- **解决**: 确保游戏窗口可见且未被遮挡

#### 实时监控无事件
- **原因**: 游戏状态稳定，未发生变化
- **解决**: 这是正常现象，不影响功能

#### 权限相关错误
- **原因**: 程序缺少访问进程/窗口的权限
- **解决**: 以管理员身份运行测试

## 支持的游戏

当前测试配置支持以下游戏进程和窗口标题：

### 进程名
- `StarRail.exe`
- `HonkaiStarRail.exe`
- `崩坏星穹铁道.exe`
- `starrail.exe`
- `honkai_star_rail.exe`

### 窗口标题
- `崩坏：星穹铁道`
- `Honkai: Star Rail`
- `StarRail`
- `Honkai Star Rail`
- `崩坏星穹铁道`

## 自定义配置

如需测试其他游戏或修改检测配置，可以编辑 `real-game-test.ts` 文件中的配置部分：

```typescript
const config: Partial<GameDetectorConfig> = {
  gameProcessNames: [
    // 添加你的游戏进程名
  ],
  gameWindowTitles: [
    // 添加你的游戏窗口标题
  ],
  detectionInterval: 500, // 检测间隔（毫秒）
  enableLogging: true,
  logLevel: 'debug'
};
```

## 日志文件

测试完成后，详细日志会保存到 `logs/` 目录，文件名格式为：
```
real-game-test-YYYY-MM-DDTHH-mm-ss-sssZ.log
```

日志包含：
- 测试执行过程
- 检测到的游戏信息
- 事件触发记录
- 错误信息（如有）

## 注意事项

1. **测试环境**: 建议在稳定的环境中运行测试，避免其他程序干扰
2. **游戏状态**: 测试期间尽量保持游戏状态稳定
3. **系统资源**: 测试会消耗一定的系统资源，建议关闭不必要的程序
4. **测试时长**: 完整测试大约需要30-60秒
5. **多次运行**: 可以多次运行测试以验证稳定性

## 故障排除

如果测试失败，请检查：

1. 游戏是否正常启动并可见
2. 是否有足够的系统权限
3. 游戏进程名和窗口标题是否匹配配置
4. 系统是否有防病毒软件阻止进程访问
5. 查看详细日志了解具体错误信息

## 贡献

如果发现测试问题或需要支持新的游戏，请：

1. 查看日志文件了解详细错误
2. 提供游戏的进程名和窗口标题信息
3. 描述测试环境和复现步骤
4. 提交Issue或Pull Request