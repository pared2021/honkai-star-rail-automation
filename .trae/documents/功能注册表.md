# 功能注册表

## 概述

本文档记录崩坏星穹铁道自动化助手项目中所有核心功能的详细信息，用于防止重复开发和确保架构一致性。

**项目信息**:
- **项目名称**: 崩坏星穹铁道自动化助手 (xingtie)
- **技术栈**: Python 3.13 + PyQt6 + SQLite
- **架构模式**: 分层架构 + MVP模式
- **最新更新**: 2025-01-06
- **测试覆盖率**: 59.17%
- **测试状态**: 61个通过，1个失败

**重要提醒**: 开发任何新功能前，必须先查阅此注册表！

---

## 核心功能注册

### 1. 游戏检测功能 (GameDetector)

**状态**: ✅ 已实现 | ✅ 已统一 | ❌ 禁止重复实现

- **模块位置**: `src/core/game_detector.py`
- **主要类**: 
  - `GameDetector`: 主要检测类
  - `TemplateMatcher`: 模板匹配器
  - `WindowDetector`: 窗口检测器
  - `GameWindow`: 游戏窗口数据类
  - `TemplateInfo`: 模板信息数据类
- **核心功能**: 
  - 检测崩坏星穹铁道游戏窗口
  - 判断游戏运行状态
  - 基于OpenCV的模板匹配
  - UI元素定位和识别
  - 游戏截图和图像处理
- **主要接口**: 
  - `detect_game_window() -> Optional[GameWindow]`
  - `is_game_running() -> bool`
  - `find_template(template_path: str, threshold: float = 0.8) -> Optional[TemplateInfo]`
  - `capture_window() -> Optional[np.ndarray]`
- **依赖**: `opencv-python`, `numpy`, `pywin32`, `Pillow`
- **测试覆盖率**: 59.17%
- **维护人员**: 开发团队
- **最后更新**: 2025-01-06
- **重复实现位置**: 
  - ✅ `src/automation/game_detector.py` (已删除，功能已合并)
- **使用示例**:
```python
from src.core.game_detector import GameDetector

detector = GameDetector()
if detector.is_game_running():
    window = detector.detect_game_window()
    if window:
        print(f"找到游戏窗口: {window.title}")
        # 查找UI元素
        element = detector.find_template("assets/templates/start_button.png")
        if element:
            print(f"找到元素，置信度: {element.confidence}")
```

---

### 2. 同步适配器功能 (SyncAdapter)

**状态**: ✅ 已实现 | ✅ 已统一 | ❌ 禁止重复实现

- **模块位置**: `src/core/sync_adapter.py`
- **主要类**: 
  - `SyncAdapter`: 主要适配器类
  - `CallbackManager`: 回调管理器
  - `AsyncCallback`: 异步回调基类
  - `SyncCallback`: 同步回调基类
- **核心功能**: 
  - 连接PyQt6 GUI线程和asyncio异步世界
  - 处理异步事件和回调机制
  - 在GUI线程中安全调用异步函数
  - 异步任务生命周期管理
  - 线程安全的事件循环管理
- **主要接口**: 
  - `run_async(coro) -> Any`
  - `add_callback(callback: CallbackType)`
  - `start_task(task_func) -> str`
  - `stop_task(task_id: str)`
  - `shutdown() -> None`
- **依赖**: `asyncio`, `PyQt6`, `typing`, `threading`
- **维护人员**: 开发团队
- **最后更新**: 2025-01-06
- **重复实现位置**: 
  - ✅ `src/ui/sync_adapter.py` (已删除，功能已合并)
  - ✅ `src/adapters/sync_adapter.py` (已删除，功能已合并)
- **使用示例**:
```python
from src.core.sync_adapter import SyncAdapter

# 在GUI线程中使用
adapter = SyncAdapter()
result = adapter.run_async(some_async_function())

# 添加异步回调
def on_task_complete(result):
    print(f"任务完成: {result}")

adapter.add_callback(on_task_complete)
```

---

### 3. 任务管理功能 (TaskManager)

**状态**: ✅ 已实现 | ✅ 已统一 | ❌ 禁止重复实现

- **主要模块位置**: 
  - `src/core/task_manager.py` (核心实现)
  - `src/services/task_service.py` (统一服务层)
  - `src/adapters/task_manager_adapter.py` (适配器)
- **主要类**: 
  - `TaskManager`: 核心任务管理器
  - `TaskService`: 统一任务服务（整合了应用层功能）
  - `TaskManagerAdapter`: 任务管理适配器
- **核心功能**: 
  - 任务的CRUD操作
  - 任务状态管理
  - 任务执行调度
  - 任务事件发布
  - 多任务并发控制
  - 任务依赖管理
  - 任务执行记录
- **主要接口**: 
  - `create_task(config: TaskConfig) -> str`
  - `start_task(task_id: str)`
  - `stop_task(task_id: str)`
  - `get_task_status(task_id: str) -> TaskStatus`
  - `execute_task(task_id: str, user_id: Optional[str] = None)`
  - `pause_task(task_id: str)`, `resume_task(task_id: str)`, `cancel_task(task_id: str)`
- **依赖**: `asyncio`, `dataclasses`, `typing`
- **维护人员**: [待分配]
- **最后更新**: 2024年
- **已删除的重复实现**: 
  - ✅ `src/core/multi_task_manager.py` (功能已合并到TaskManager)
  - ✅ `src/services/task_application_service.py` (功能已合并到TaskService)
  - ✅ `src/application/task_application_service.py` (功能已合并到TaskService)
- **使用示例**:
```python
from src.services.task_service import TaskService

task_service = TaskService()
task_id = task_service.create_task(task_config)
task_service.execute_task(task_id)
```

---

### 4. 自动化控制器 (AutomationController)

**状态**: ✅ 已实现 | ✅ 允许扩展

- **模块位置**: `src/automation/automation_controller.py`
- **主要类**: `AutomationController`
- **核心功能**: 
  - 协调游戏检测和任务执行
  - 提供自动化流程控制
  - 处理自动化业务逻辑
  - 管理自动化任务生命周期
- **主要接口**: 
  - `start_automation()`
  - `stop_automation()`
  - `get_automation_status()`
  - `execute_task(task_config)`
- **依赖**: `GameDetector`, `TaskManager`, `SyncAdapter`
- **维护人员**: 开发团队
- **最后更新**: 2025-01-06
- **扩展指南**: 新的自动化功能应该通过扩展此控制器实现

---

### 5. 数据库管理器 (DatabaseManager)

**状态**: ✅ 已实现 | ✅ 已统一 | ❌ 禁止重复实现

- **模块位置**: `src/database/db_manager.py`
- **主要类**: 
  - `DatabaseManager`: 数据库连接管理
  - `MigrationManager`: 数据库迁移管理
- **核心功能**: 
  - SQLite数据库连接管理
  - 数据库迁移和版本控制
  - 连接池管理
  - 事务处理
- **主要接口**: 
  - `get_connection() -> Connection`
  - `execute_query(sql: str, params: tuple)`
  - `run_migrations()`
  - `close_all_connections()`
- **依赖**: `aiosqlite`, `sqlite3`
- **维护人员**: 开发团队
- **最后更新**: 2025-01-06

---

### 6. 事件总线系统 (EventBus)

**状态**: ✅ 已实现 | ✅ 已统一 | ❌ 禁止重复实现

- **模块位置**: `src/services/event_bus.py`
- **主要类**: 
  - `EventBus`: 事件总线主类
  - `Event`: 事件基类
- **核心功能**: 
  - 异步事件发布和订阅
  - 事件路由和分发
  - 事件处理器管理
  - 事件历史记录
- **主要接口**: 
  - `publish(event: Event)`
  - `subscribe(event_type: Type[Event], handler: Callable)`
  - `unsubscribe(event_type: Type[Event], handler: Callable)`
- **依赖**: `asyncio`, `typing`
- **维护人员**: 开发团队
- **最后更新**: 2025-01-06

---

### 7. 监控系统 (MonitoringSystem)

**状态**: ✅ 已实现 | ⚠️ 持续完善

- **模块位置**: 
  - `src/monitoring/health_checker.py`
  - `src/monitoring/alert_manager.py`
  - `src/monitoring/task_monitor.py`
- **主要类**: 
  - `HealthChecker`: 系统健康检查
  - `AlertManager`: 告警管理
  - `TaskMonitor`: 任务监控
- **核心功能**: 
  - 系统健康状态监控
  - 任务执行状态监控
  - 告警通知和处理
  - 性能指标收集
- **主要接口**: 
  - `start_monitoring()`
  - `stop_monitoring()`
  - `get_health_status()`
  - `send_alert(alert: Alert)`
- **依赖**: `psutil`, `asyncio`
- **维护人员**: 开发团队
- **最后更新**: 2025-01-06

---

### 8. 配置管理系统 (ConfigManager)

**状态**: ✅ 已实现 | ✅ 已统一 | ❌ 禁止重复实现

- **模块位置**: 
  - `src/config/database_config.py`
  - `src/repositories/config_repository.py`
- **主要类**: 
  - `DatabaseConfig`: 数据库配置
  - `ConfigRepository`: 配置数据访问
- **核心功能**: 
  - 应用配置管理
  - 环境配置切换
  - 配置持久化
  - 配置验证和默认值
- **主要接口**: 
  - `get_config(key: str)`
  - `set_config(key: str, value: Any)`
  - `load_config_from_file(path: str)`
  - `save_config_to_file(path: str)`
- **依赖**: `pydantic`, `json`, `yaml`
- **维护人员**: 开发团队
- **最后更新**: 2025-01-06

---

## 数据模型注册

### 1. 任务相关模型

**状态**: ✅ 已实现 | ✅ 已统一

- **TaskConfig**: 任务配置数据类
- **Task**: 任务实体数据类
- **TaskStatus**: 任务状态枚举
- **TaskResult**: 任务执行结果
- **位置**: `src/models/task_models.py`
- **主要字段**:
  - `task_id`: 任务唯一标识
  - `task_type`: 任务类型
  - `config`: 任务配置参数
  - `status`: 任务状态
  - `created_at`: 创建时间
  - `updated_at`: 更新时间

### 2. 游戏相关模型

**状态**: ✅ 已实现 | ✅ 已统一

- **GameWindow**: 游戏窗口数据类
- **TemplateInfo**: 模板匹配信息
- **UIElement**: UI元素数据类
- **位置**: `src/core/game_detector.py` (内嵌数据类)
- **主要字段**:
  - `handle`: 窗口句柄
  - `title`: 窗口标题
  - `rect`: 窗口位置和大小
  - `confidence`: 匹配置信度
  - `location`: 元素位置坐标

### 3. 基础架构模型

**状态**: ✅ 已实现 | ✅ 已统一

- **BaseModel**: MVP模式基础模型
- **BaseView**: MVP模式基础视图
- **BasePresenter**: MVP模式基础展示器
- **位置**: `src/ui/mvp/`
- **核心功能**:
  - 提供MVP架构基础框架
  - 信号槽机制支持
  - 异步操作支持

---

## 工具函数和服务注册

### 1. 仓储层 (Repository Layer)

**状态**: ✅ 已实现 | ✅ 已统一

- **BaseRepository**: 基础仓储类 (`src/repositories/base_repository.py`)
- **TaskRepository**: 任务数据访问 (`src/repositories/task_repository.py`)
- **ConfigRepository**: 配置数据访问 (`src/repositories/config_repository.py`)
- **QueryExecutor**: 查询执行器 (`src/repositories/query_executor.py`)
- **核心功能**:
  - 统一数据访问接口
  - 查询构建器模式
  - 异步数据库操作
  - 事务管理

### 2. 适配器层 (Adapter Layer)

**状态**: ✅ 已实现 | ✅ 已统一

- **ModelAdapter**: 模型适配器 (`src/adapters/model_adapter.py`)
- **TaskManagerAdapter**: 任务管理适配器 (`src/adapters/task_manager_adapter.py`)
- **核心功能**:
  - 不同架构层间的数据转换
  - 接口适配和兼容
  - 依赖解耦

### 3. 工具类 (Utilities)

**状态**: ✅ 已实现 | ✅ 已统一

- **Helpers**: 通用工具函数 (`src/utils/helpers.py`)
- **核心功能**:
  - 通用工具函数
  - 数据处理辅助
  - 文件操作工具

### 4. GUI组件库

**状态**: ✅ 已实现 | ⚠️ 需要统一到MVP

- **MainWindow**: 主窗口 (`src/gui/main_window.py`)
- **AutomationSettingsWidget**: 自动化设置 (`src/gui/automation_settings_widget.py`)
- **GameSettingsWidget**: 游戏设置 (`src/gui/game_settings_widget.py`)
- **CommonGUIComponents**: 通用组件 (`src/gui/common/gui_components.py`)
- **MVP实现**: `src/ui/main_window/` (新架构)
- **迁移状态**: 传统GUI组件需要迁移到MVP架构

---

## 重复功能清理计划

### ✅ 已完成的清理任务

1. **GameDetector重复实现** ✅
   - ✅ 保留: `src/core/game_detector.py`
   - ✅ 删除: `src/automation/game_detector.py`
   - ✅ 迁移: 将有用的功能合并到核心实现

2. **SyncAdapter重复实现** ✅
   - ✅ 保留: `src/core/sync_adapter.py`
   - ✅ 删除: `src/ui/sync_adapter.py`, `src/adapters/sync_adapter.py`
   - ✅ 迁移: 将有用的功能合并到核心实现

3. **TaskManager功能统一** ✅
   - ✅ 统一接口设计
   - ✅ 合并分散的实现
   - ✅ 建立清晰的分层
   - ✅ 删除: `src/core/multi_task_manager.py`
   - ✅ 删除: `src/services/task_application_service.py`
   - ✅ 删除: `src/application/task_application_service.py`
   - ✅ 统一到: `src/services/task_service.py`

### 清理成果

- **删除重复文件**: 6个
- **统一核心功能**: 3个
- **测试通过率**: 100% (27/27)
- **架构一致性**: ✅ 已达成

**注意**: 所有核心功能现在都有唯一实现，严禁重复开发！

---

## 开发检查清单

### 新功能开发前必须检查

- [ ] 在此注册表中搜索相关功能
- [ ] 确认没有重复实现
- [ ] 评估是否可以扩展现有功能
- [ ] 确定正确的模块位置
- [ ] 检查依赖关系

### 功能开发完成后必须更新

- [ ] 在注册表中添加新功能记录
- [ ] 更新相关功能的依赖关系
- [ ] 标记任何被替代的功能
- [ ] 更新使用示例

---

## 维护记录

### 更新历史

- **2024年**: 初始版本创建
- **待更新**: 重复功能清理完成后更新

### 下次审查时间

- **每月审查**: 检查新增功能和重复情况
- **季度大审查**: 全面评估架构一致性

---

## 联系信息

**文档维护**: 开发团队  
**问题反馈**: [待设置]  
**紧急联系**: [待设置]  

---

**⚠️ 重要提醒**: 
1. 开发任何功能前必须查阅此表
2. 发现重复功能立即报告
3. 完成开发后立即更新此表
4. 定期参与功能注册表审查会议