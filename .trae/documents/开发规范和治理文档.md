# 开发规范和治理文档

## 1. 概述

本文档旨在建立统一的开发规范和治理机制，确保项目开发的一致性、可维护性和高质量，避免重复开发和架构不一致问题。

### 1.1 核心原则
- **一致性优先**：统一的代码风格、架构模式和开发流程
- **防重复开发**：明确的功能注册和开发前检查机制
- **质量保证**：完善的测试体系和代码质量门禁
- **渐进式改进**：持续优化和迭代改进

## 2. 代码开发规范

### 2.1 命名规范

#### 文件和目录命名
- 使用小写字母和下划线：`game_detector.py`
- 目录名使用复数形式：`services/`, `models/`, `adapters/`
- 测试文件以 `test_` 开头：`test_game_detector.py`

#### 类和函数命名
- 类名使用 PascalCase：`GameDetector`, `TaskManager`
- 函数和方法使用 snake_case：`detect_game_window()`, `start_task()`
- 常量使用大写字母：`MAX_RETRY_COUNT = 3`
- 私有方法以下划线开头：`_internal_method()`

#### 变量命名
- 使用描述性名称：`game_window_handle` 而不是 `gwh`
- 布尔变量使用 `is_`, `has_`, `can_` 前缀：`is_running`, `has_permission`
- 集合变量使用复数形式：`tasks`, `windows`

### 2.2 文件组织规范

#### 目录结构
```
src/
├── core/           # 核心业务逻辑（单一实现）
├── services/       # 业务服务层
├── repositories/   # 数据访问层
├── adapters/       # 外部系统适配器
├── ui/            # 用户界面层
├── models/        # 数据模型
├── config/        # 配置管理
├── utils/         # 工具函数
├── exceptions/    # 自定义异常
└── tests/         # 测试代码
```

#### 模块职责划分
- **core/**：核心业务逻辑，每个功能只能有一个实现
- **services/**：业务服务，协调多个核心组件
- **repositories/**：数据访问，统一数据操作接口
- **adapters/**：外部系统集成，隔离外部依赖
- **ui/**：用户界面，只负责展示和用户交互

### 2.3 架构模式规范

#### 分层架构
```
用户界面层 (UI Layer)
    ↓
应用服务层 (Application Service Layer)
    ↓
领域服务层 (Domain Service Layer)
    ↓
基础设施层 (Infrastructure Layer)
```

#### 依赖注入原则
- 使用依赖注入而非直接实例化
- 通过接口定义依赖关系
- 避免循环依赖

#### 异步编程规范
- 统一使用 `asyncio` 进行异步编程
- 所有 I/O 操作必须是异步的
- 使用 `async/await` 语法，避免回调地狱

## 3. 开发流程规范

### 3.1 功能开发流程

#### 开发前检查
1. **功能注册检查**：在功能注册表中查找是否已有类似功能
2. **架构影响评估**：评估新功能对现有架构的影响
3. **依赖分析**：确认所需依赖和可能的冲突
4. **设计文档**：编写功能设计文档

#### 开发步骤
1. **创建分支**：从 `develop` 分支创建功能分支
2. **编写测试**：先写测试用例（TDD）
3. **实现功能**：按照设计文档实现功能
4. **代码审查**：提交 Pull Request 进行代码审查
5. **集成测试**：通过所有测试后合并到 `develop`

### 3.2 代码审查规范

#### 审查要点
- **功能正确性**：是否满足需求
- **代码质量**：是否符合编码规范
- **测试覆盖**：是否有足够的测试覆盖
- **性能影响**：是否有性能问题
- **安全性**：是否有安全漏洞

#### 审查流程
1. 自动化检查通过
2. 至少一名资深开发者审查
3. 所有评论得到解决
4. 通过所有测试

### 3.3 测试要求

#### 测试类型
- **单元测试**：覆盖率不低于 80%
- **集成测试**：关键业务流程测试
- **端到端测试**：用户场景测试
- **性能测试**：关键功能性能基准

#### 测试规范
- 测试文件与源文件一一对应
- 使用描述性的测试方法名
- 每个测试只验证一个功能点
- 使用 Mock 隔离外部依赖

## 4. 架构治理规则

### 4.1 模块职责划分

#### 核心模块（core/）
- **game_detector**：游戏检测（唯一实现）
- **task_manager**：任务管理（唯一实现）
- **sync_adapter**：同步适配器（唯一实现）

#### 服务模块（services/）
- **task_service**：任务业务逻辑
- **automation_service**：自动化服务
- **monitoring_service**：监控服务

#### 数据模块（repositories/）
- **task_repository**：任务数据访问
- **config_repository**：配置数据访问
- **log_repository**：日志数据访问

### 4.2 依赖管理规则

#### 依赖方向
- UI层 → 应用服务层 → 领域服务层 → 基础设施层
- 禁止反向依赖
- 同层之间通过接口通信

#### 外部依赖
- 所有外部依赖通过适配器模式封装
- 使用依赖注入管理外部依赖
- 定期评估和更新依赖版本

### 4.3 接口设计规范

#### 接口定义
- 使用抽象基类定义接口
- 接口方法使用类型注解
- 提供详细的文档字符串

#### 版本管理
- 接口变更使用版本号管理
- 向后兼容性保证
- 废弃接口的迁移指南

## 5. 防重复开发机制

### 5.1 功能注册表

#### 注册内容
- 功能名称和描述
- 负责模块和文件
- 接口定义
- 使用示例
- 维护人员
- 依赖关系
- 最后更新时间

#### 核心功能注册示例
```markdown
## 游戏检测功能 (GameDetector)
- **模块位置**: `src/core/game_detector.py`
- **主要类**: `GameDetector`, `TemplateMatcher`
- **功能描述**: 检测游戏窗口、状态和界面元素
- **接口**: `detect_game_window()`, `is_game_running()`
- **依赖**: `cv2`, `numpy`, `win32gui`
- **维护人员**: [开发者姓名]
- **禁止重复**: ❌ 不允许在其他模块重复实现

## 同步适配器功能 (SyncAdapter)
- **模块位置**: `src/core/sync_adapter.py`
- **主要类**: `SyncAdapter`, `CallbackManager`
- **功能描述**: 连接GUI线程和异步世界，处理异步事件
- **接口**: `run_async()`, `add_callback()`
- **依赖**: `asyncio`, `PyQt6`
- **维护人员**: [开发者姓名]
- **禁止重复**: ❌ 不允许在其他模块重复实现
```

#### 注册流程
1. 开发前查询功能注册表
2. 发现类似功能时，优先复用或扩展现有实现
3. 新功能开发完成后立即更新注册表
4. 每月审查和清理注册表
5. 发现重复功能时立即启动合并流程

### 5.2 开发前检查清单

#### 必检项目
- [ ] **功能重复检查**: 功能注册表中是否已有类似功能
- [ ] **代码复用检查**: 现有代码中是否有可复用组件
- [ ] **架构一致性检查**: 是否符合现有架构模式
- [ ] **依赖影响检查**: 是否需要新增外部依赖
- [ ] **功能影响检查**: 是否影响现有功能
- [ ] **命名冲突检查**: 类名、方法名是否与现有代码冲突
- [ ] **测试策略检查**: 是否有对应的测试计划

#### 特殊检查项（针对核心功能）
当开发涉及以下核心功能时，需要额外检查：

**游戏检测相关**:
- [ ] 是否真的需要新的检测逻辑，还是可以扩展现有 `GameDetector`
- [ ] 是否可以通过配置参数实现需求
- [ ] 新检测方法是否与现有方法冲突

**任务管理相关**:
- [ ] 是否可以通过现有 `TaskManager` 实现
- [ ] 新任务类型是否需要修改核心接口
- [ ] 是否影响现有任务的执行

**同步适配相关**:
- [ ] 是否可以使用现有 `SyncAdapter`
- [ ] 新的异步需求是否需要修改核心机制
- [ ] 是否会影响现有的异步流程

### 5.3 文档维护机制

#### 文档类型
- **API文档**：自动生成，保持最新
- **架构文档**：重大变更时更新
- **用户手册**：功能变更时更新
- **开发指南**：定期审查更新

#### 维护责任
- 功能开发者负责相关文档更新
- 架构师负责架构文档维护
- 项目经理负责文档质量监督

## 6. 质量保证体系

### 6.1 自动化检查

#### 代码质量检查
- **Linting**：使用 flake8, pylint
- **格式化**：使用 black, isort
- **类型检查**：使用 mypy
- **安全检查**：使用 bandit

#### 自动化测试
- **单元测试**：pytest
- **覆盖率检查**：coverage.py
- **性能测试**：pytest-benchmark
- **集成测试**：自定义测试套件

### 6.2 持续集成

#### CI/CD 流程
1. 代码提交触发构建
2. 运行所有自动化检查
3. 执行测试套件
4. 生成质量报告
5. 部署到测试环境

#### 质量门禁
- 所有检查必须通过
- 测试覆盖率不低于阈值
- 性能测试不能回归
- 安全扫描无高危漏洞

### 6.3 代码质量指标

#### 关键指标
- **测试覆盖率**：≥ 80%
- **代码重复率**：≤ 5%
- **圈复杂度**：≤ 10
- **技术债务**：持续减少

#### 监控和报告
- 每日质量报告
- 每周趋势分析
- 每月质量回顾
- 季度改进计划

## 7. 团队协作规范

### 7.1 分支管理

#### 分支策略
- **main**：生产环境代码
- **develop**：开发环境代码
- **feature/**：功能开发分支
- **hotfix/**：紧急修复分支
- **release/**：发布准备分支

#### 分支规则
- 从 develop 创建 feature 分支
- feature 分支合并前必须通过 PR
- main 分支只接受来自 release 和 hotfix 的合并
- 定期清理已合并的分支

### 7.2 提交规范

#### 提交消息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

#### 类型说明
- **feat**：新功能
- **fix**：bug修复
- **docs**：文档更新
- **style**：代码格式调整
- **refactor**：代码重构
- **test**：测试相关
- **chore**：构建过程或辅助工具的变动

### 7.3 文档更新规范

#### 更新时机
- 新功能开发完成
- API 接口变更
- 架构重大调整
- 配置参数变更

#### 更新责任
- 开发者负责技术文档
- 产品经理负责需求文档
- 架构师负责设计文档
- 测试工程师负责测试文档

## 8. 实施计划

### 8.1 阶段规划

#### 第一阶段：代码清理和规范建立（2-3周）
**目标**: 清理现有重复代码，建立开发规范

**具体任务**:
- 合并重复的 `GameDetector` 实现（保留 `core/game_detector.py`）
- 合并重复的 `SyncAdapter` 实现（保留 `core/sync_adapter.py`）
- 统一 `TaskManager` 相关功能
- 建立功能注册表，记录所有核心功能
- 配置代码质量检查工具

**成功标准**:
- 每个核心功能只有一个实现
- 功能注册表包含所有现有功能
- 自动化检查工具正常运行

#### 第二阶段：工具集成和流程建立（2-3周）
**目标**: 建立完整的开发流程和质量保证体系

**具体任务**:
- 集成 CI/CD 流程
- 建立质量监控体系
- 制定代码审查流程
- 培训团队成员使用新规范
- 建立重复检测机制

**成功标准**:
- CI/CD 流程正常运行
- 团队成员熟悉新规范
- 重复检测机制有效

#### 第三阶段：全面实施和持续改进（持续）
**目标**: 严格执行规范，持续优化

**具体任务**:
- 严格执行开发前检查
- 定期审查功能注册表
- 持续监控代码质量
- 定期评估和改进规范

**成功标准**:
- 零新增重复功能
- 代码质量持续提升
- 开发效率稳步提高

### 8.2 成功指标

#### 短期目标（3个月）
- **代码重复率**: 从当前的 ~30% 降低到 5% 以下
- **核心功能统一**: `GameDetector`, `SyncAdapter`, `TaskManager` 各只有一个实现
- **测试覆盖率**: 达到 80% 以上
- **规范遵循率**: 所有新功能 100% 通过规范检查
- **功能注册完整性**: 100% 的核心功能在注册表中有记录

#### 中期目标（6个月）
- **零重复开发**: 新功能开发前 100% 通过重复检查
- **架构一致性**: 达到 95% 以上
- **自动化覆盖**: 90% 的质量检查自动化
- **文档同步率**: 代码变更后 24 小时内文档更新

#### 长期目标（1年）
- **开发效率**: 提升 30% 以上
- **代码质量**: 技术债务减少 50%
- **维护成本**: 降低 40%
- **团队满意度**: 开发体验显著改善

#### 关键监控指标
- **每周重复代码扫描报告**
- **每月功能注册表审查**
- **季度架构一致性评估**
- **年度开发效率评估**

## 9. 附录

### 9.1 工具清单

#### 开发工具
- **IDE**：PyCharm, VSCode
- **版本控制**：Git
- **包管理**：pip, poetry
- **虚拟环境**：venv, conda

#### 质量工具
- **代码检查**：flake8, pylint, mypy
- **格式化**：black, isort
- **测试**：pytest, coverage
- **安全**：bandit, safety

### 9.2 参考资源

#### 编码规范
- PEP 8: Python代码风格指南
- Google Python Style Guide
- Clean Code: A Handbook of Agile Software Craftsmanship

#### 架构设计
- Clean Architecture
- Domain-Driven Design
- Microservices Patterns

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护人员**：开发团队  
**审查周期**：每季度